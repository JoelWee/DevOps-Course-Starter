FROM ubuntu:bionic as base

RUN apt-get update && apt-get install -y \
  python3.8 python3-pip \
  fonts-liberation libappindicator3-1 libasound2 libatk-bridge2.0-0 \
  libnspr4 libnss3 lsb-release xdg-utils libxss1 libdbus-glib-1-2 \
  curl unzip wget \
  xvfb


RUN apt-get update && apt-get install -y \
  fonts-liberation libappindicator3-1 libasound2 libatk-bridge2.0-0 \
  libnspr4 libnss3 lsb-release xdg-utils libxss1 libdbus-glib-1-2 \
  curl unzip wget \
  xvfb


# install geckodriver and firefox

RUN GECKODRIVER_VERSION=`curl https://github.com/mozilla/geckodriver/releases/latest | grep -Po 'v[0-9]+.[0-9]+.[0-9]+'` && \
  wget https://github.com/mozilla/geckodriver/releases/download/$GECKODRIVER_VERSION/geckodriver-$GECKODRIVER_VERSION-linux64.tar.gz && \
  tar -zxf geckodriver-$GECKODRIVER_VERSION-linux64.tar.gz -C /usr/local/bin && \
  chmod +x /usr/local/bin/geckodriver && \
  rm geckodriver-$GECKODRIVER_VERSION-linux64.tar.gz

RUN FIREFOX_SETUP=firefox-setup.tar.bz2 && \
  apt-get purge firefox && \
  wget -O $FIREFOX_SETUP "https://download.mozilla.org/?product=firefox-latest&os=linux64" && \
  tar xjf $FIREFOX_SETUP -C /opt/ && \
  ln -s /opt/firefox/firefox /usr/bin/firefox && \
  rm $FIREFOX_SETUP

RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.6 1 && \
  update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.8 2

WORKDIR /app

RUN pip3 install poetry \
  && poetry config virtualenvs.create false

COPY poetry.lock pyproject.toml /app/
RUN poetry install

FROM base as test_watch
COPY ./scripts /app/scripts
RUN chmod +x "scripts/run_tests_watch.sh" && pip3 install argh
ENTRYPOINT [ "scripts/run_tests_watch.sh" ]

FROM base as ci
COPY . /app
RUN chmod +x "scripts/run_tests.sh"
ENTRYPOINT [ "scripts/run_tests.sh" ]
