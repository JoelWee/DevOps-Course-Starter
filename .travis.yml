services:
  - docker

before_install:
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin

install:
  - docker pull j0elwee/devops-trg
  - docker build --build-arg BUILDKIT_INLINE_CACHE=1 --cache-from j0elwee/devops-trg -t j0elwee/devops-trg -t j0elwee/devops-trg:$TRAVIS_COMMIT --target production .
  - docker pull j0elwee/devops-trg:python-3.8-slim-buster-with-geckodriver
  - docker build --build-arg BUILDKIT_INLINE_CACHE=1 --cache-from j0elwee/devops-trg:python-3.8-slim-buster-with-geckodriver -t j0elwee/devops-trg:python-3.8-slim-buster-with-geckodriver -f Dockerfile.test.base .
script:
  - docker-compose -f docker-compose.test.yml up --exit-code-from tests

before_deploy:
  - echo $DOCKER_HUB_PASSWORD | docker login -u j0elwee --password-stdin
  - docker push j0elwee/devops-trg
  - docker push j0elwee/devops-trg:$TRAVIS_COMMIT
  - docker push j0elwee/devops-trg:python-3.8-slim-buster-with-geckodriver
  - wget https://releases.hashicorp.com/terraform/"$TF_VERSION"/terraform_"$TF_VERSION"_linux_amd64.zip
  - unzip terraform_"$TF_VERSION"_linux_amd64.zip
  - sudo mv terraform /usr/local/bin/
  - rm terraform_"$TF_VERSION"_linux_amd64.zip
  - terraform init
  - terraform apply -auto-approve -var "oauth_client_id=$OAUTH_CLIENT_ID" -var "oauth_client_secret=$OAUTH_CLIENT_SECRET" -var "secret_key=$SECRET_KEY"
  - export AZURE_WEBHOOK="$(terraform output -raw webhook_url)"
deploy:
  provider: script
  script: bash scripts/deploy.sh
  on: 
    branch: master
env:
  global:
  - TF_VERSION=0.14.7
  - DOCKER_COMPOSE_VERSION=1.28.2
  - secure: UwMUyLZN1g+zqo+7+xIftHXzpWSKUWhS2DZHQSMdPURlD/n9GMZvuJXJ7mzh1MV1KJi+acIPE7Ho3pLVdu1zTkJ47oN8dsnLzXih6yaqD768b51/u0v/G49+9nsjUBkQ5ds7ZvC9OyW1uYKU1aUfjL9X3ejcbmUbfXTMLGPFPbRS/4S3a9HmgzYjFCPPEMZvwppufojhZ72HirjYISRk0KjB+KWcmqShpsZvef+H4VEdGTsdiWjhq3SaTU1R7FF5kcg4j3hN5guZFwIYfJMVG8RouCvzGU2voAbBNImu5Dugwna0cZJPZVJvz88vTimMKal8E22EC3aNaduB9pNcF9lWYmSwL/aoXCGfXke9swXRtSV4Ma+cpZYFb+ju/Af2WoOybs9ygTH5L5aV7wg3P5XuB1AkCPbr1uQsmQbENvDqJNU8hhDmezYXhr4jLOtZ8DF37jtMDhUAeFhQpKZMcxaay5cvaupEUILI1QaFWSmcYgXWz0yonR0gooXZHfZYJZZ98nFqOGGsLgrz/M0DVN6EBBRqNXjKW8RtTzHXRDe2EuPu2r7UrLbE1upTAHwc9xtAWxVorTxkpZvFA9bml0HGjS8ak2yRfVxrDC/Xm5wGPsNBLkRh73h2H5UjOjEyRiumPOKM/JrEwysd/J3sxZuqeQ1uaEzdIIcYuQTSNVw=
  - secure: "eZNHbWyD1gGrlMwTvSdgk5zW9/6r1zApodsYsWfnpvU6J42dkmo0G+xuhNDugYO24hkBia/SIwg2gszsyy8vWNIR2/+wOqnd1uWNq3y40uPBso+9Ii6q0ofYvsk2EWZr/cQh0yzoPsaRopTyfDN1z/P1cC2J0yEYvWJWRjh7iOCjSzvOw91cCkWE+2X/ANSpx4PefPgs5rXcJvLux7QWpsnc3gDwrwG+UwcY1oz088TI2pApvjBrnSBMxL2GfCVB0wyO+Bt/RSNrti8W3k2+PSEP+zFb8GNTWw7wcoLRw/HzNkwoSMp10ubWkhp/5dpEWLMPX7snWbqs2oai/ElK+TQw7UI4kn9/e+r268JttLUOPye7PSnz8cwDapX9fy95jpzyDPqFYdg2FVosM/08cY7Hg1pVGWDGC/fST3QGQAFXXm6WGl/mW0T8HkGZEHEHgVYTpA/hyl+xIADv6lb/rayUwU92b0mCnIzwnjiQifXSMl7oJ+aoseRNPqTayw9JCU7aW8rHApIQWitrgjrye4F6HuvVL3T/cVHi58vhBA9dT/B7B+8TEvzCw8N8aT86bzAKdoMLHYZz0pd8GO3lgwsueO0QgUVClIQThsWH4oHurxFFRDrbsOorKpALq1ufvmBsbJCto/ewAnuPBygw+0Xmpew1UuUs1ppKaNVfgKI="
  - secure: "Xg+n1e5ur8vwlOZWl5NUdLJuD5IOpu6L/rpqm8k4aBX6Fm4KzX34sYBHySaFrm6cH5YgJu1LenYqe7w2DbX/4f0u0IemM4oTCOFA6hAhHVXykboueUHKS2WmoRNLa0V3fkyuZl5yOdmuH4xP1SkFJMZA2dXXSn02XbTxS7uLM3GwCuDw+TMVn+4svucWrLU9YfNwBRmgWfvVKytk9Ba49rvO+8ZgD5gIJNqlg/plyzz7jsIlotgOq7vZTgQgBpRVAzmut3IxeUbGyJPhsKFURsjARn4GSBb5EQxew4dkn1uiAP8Fr5b2i8NBjycKvwP4WeTWQzg1PbW8ionZxlfT11qymLsl6/k+WYOCpyRnN711tmfOc64bOjg+2nvEe6B/yYhjN4ktHXF3GuzyvIyQIOJHrIfuMI4VFNBmgGJjN6LKrJ+O77dJWgVEOHQrOQWP9+tO/XD9kqJqQOIz8w0+LxElyrTdjPDT20njA/xY00fr1N4OJvY6+2BhYmu4gy7IgG9D2LWvk6oWVmt73DIyRGO7OZInbVkEOh1FkpE1uf0Wf4EpXgSmzjuulAtI0i+WWtNl6Oj+nJLY9ST1l+9S3mbXdUISoyrChGlhqiVlgC/IgwTrjmr5FJSF0q09hcrK0tMqBa79QOkbb7ArsyxJAButNby189pQoz0Rc/XAkyQ="
  - secure: "Qiue+ICAfgJuKMUK/gYNrZHPUPXi92WK+g35BH0rlp93/66J5CZj6yD2swyrPVyIDHhN+YsxLnr/W7LXlHFEqAvyx3qoQHAHFweLTTiAbE1yCj7PqIh1DKwCapVAVG30RoMEOPI9bsVC0hmclJmdCDA6dn6FM3gg0BUr98x/TC5qUA6w2KYO47tMoe44L780vJkIBoRbUAK3py90EEyzY9/iK1kQJqdfrSTy+7obJl9Nd0aUFBskh3bWYmhLf3vpCQFflD01mqz/MBoYXRzCGbL1g1PzJy9Rmpd0sqUBrlb4KZnmEnZ5H9Tta7JkAnL6uMSgGwttgDnkcm370yamyHR2xv8CS4AB4aYB/4ygTWhNUDGsB+45alM6COyXaBlMaGSX9dMnKIYcVBhVVGH2PGQldH1E4aJEmRHOo/WmkDbt0ChFds2OixbrUVayfldsIYPsrskuxkHI4uiGyDuz70rf9VtI765P2fMynvBril05v10JH7aUqLtXcnAS9KATv+s7n2Cb2k7to/k7T1lJT8w4ehOgUkwMjXFqcCH4hPmh906Vj1Mf1Zhc5yu06XZgJeYI3VxqeK3esn0iOik57gAfUOaO34Hvfe4EJweUVc1KdFIXjCNnIl8H+MQbgBPiE8UMX139OaMq0ZvFN6hM180Mw7CltiX1l1amdInX/BA="
  - secure: "qgjV3lDPZVeTkcd+U0g3PCDChNC8fBIheM+mJErKT40G9U715uCahrrh/LoqdDPTVdCyE+WbEjw+x7ZzSKFOoODIi++iPo/PgG8og+/hXQlwpQ1lnXs3qblMfJsZInc2P4Kw6WeGsOoMSBsJaXS74HS+SZj3RXevsCm9lyFu9i+GTntlEJC3hjNmYNs5SwCokVaRF+U1wwhD3ujjx+C1zyxmeRziORtSxCotmRIr5ilboz+VU43CkH+44eOeoUUwJQRTQc1jEW09nUSC+IiuMs8vUHidyLucvcXqBcXIIRZkjQuaZnyy/pqy5HfGF2k7ucwGoOF6dWrhBybqlCNjTmxSuB91ExqtNSv8P2diSsDDsWyGRDN5uDEs/v9DPuXstfws+2/NLRHC6El50EQJ6h/uOJouG/9CafofhHrjvkARLxI+OSCz4brVUZfaK56P9wc2bg8rgJutE3PRcfix0ogCP+q/xlGDbUTbejcNqoY4CKzpobxIWj6WFUptK5zmDAjsljjgu7+2pEO3HVUeuINfdBTbhaRvvzONzZfuoOvBv8Yh/nANuETJFQQRpZgA3+yTyqs30uiUxYnFkBUJmoGU+8rrxYSU8DfkGk32WzoLkT85119QZ0OdIDLEIhargD9kQepiJWU4mVJgxTBamupQ7zBfolvyM8i17Dg52H4="
  - secure: "StgI940DxRxG62OgNXOdRdC2pht563uKAlOnuFpPBGSwIRUvVSmGpPIG2iucXphmnWe/R3ut/olo560uHP0PTLOKlwO+0lcL1I5UsESVlFQdJhsVUotR3bk8c28Nbjzj+9h1THQSNO9tBSCy2LrhDc2N57DTfeSVkWQ4MQdvcQWWTy1m4X8mKyygGLHHOZSevI9rC3LD0nICa9+zlE52jeSlw63zr378fJrEMdtY//T0gWaKNJvgTPK0nJpBozOSiTPVcVJy1q9cUEpILJruNOfGTpgViwAoQ4gf3GM/YCDO1xgBcbX+iNVcfXZcDoSFmtt3JgMxc2vFxRf5PHyw6ppF+E15x/fy1eungEQrsk2I12mKOrZu4O1qilRsSFoiMOD8l3oNUPgSKhBGPottjCcd6Uo3y2ujQOhkcRQ16pXO5tIKM2rlWgK34RvIWDDOZBe27YbzDN0P2GOk0CKcug1xyKRLKTfMbU/HOLYd0ijR/wBzSsidY5bfRerZnHEdpXQyRgPKJIdSJWQY3SUtukPd4XwStBhhxsG8ESrS01wYrNZ85u0BPb25cmBZ0uxiuXboITj5uArQ7aFYskZkxCMTnOTAemYq/n/R/NgWw2cSUJoyb9agdc68EII+s+/hHMUTAmMh5PT3tLSmcrhHMZndW86aGdn2shRTkaGFGAo="
  - secure: "rbW7/5Qgmm1cRC2Rc3lNWlrXbS2qok8SQ3HBvPX1g5lputP3SuVFdhKpBCzQnPVRTCm83bLU8WJNZCMEjDeGVvaUeEvUEQ22DfU6X/tbbRej4m8/H05o67Kjt/7dNhRptGDXBHQJWdjwfPAwMdCGrLPm+TdgEhm8WO3L1t3whLHIirNy1b2zEudFBcYswfO7tNuTrGDfAdLyWaBikFRYVacdm7Grw/PgUhawziBWb6Vr5sWAucNdFqGzKQM2EbuxD++3Jbjm49bFpxm7fOvXmYYOXXVHsYQBze31GyZCxOV/DzZrwpeOmnZvnsTvVem2rPglsYtRaXjbomkyaxEhOTe198dzUAtBOa5gEvtYC6sdaJllEAw7y5sgsxf6icCRvf4eVg8ZU6GJnplz+NEokYcC2Ffw65O6ywmeY491nNFQ5qGYmajXxc5GPTIzKuxFaekrJ2kuH3vvA1+KBm7ZMtoMTUQ+7Xv6clrnYNaLgjEbIWUyxwO08qpHi6UKrLracnIRs4bmv6o/q8/+jK/WTIXQwx/myjS9WgDbkAnGwujdjgfQQmMZU6RGqCzlOEG9o7st55FBMUq4Np+6OsISidg9CPSAB2YhB5OAW1htCq2fky6wcW5NHQkWP0SQUTMuAO3gznuEAkvWzKuBunjUwtVrSNR59mblDFZDvajh/mo="
  - secure: "UX8Y1i9GhV3oSsq7s5fI2KyTUJfGH7JR/2Nk11EvvcrVEfQZFaK8kJHqOM+B9pSEHEQ8o4rpQ6UF7IGDo6pdFEsxXQjWcFLawa6LZIbIM5xWSP/fWbvayPYwdb0xSk0g3gmt3l0c7nLVsBLXiuspYBifkjj/DEQMygY+Q/aEGamJZ2vggcQbyZdAITxiUQX4qBd5M6SbBjRKCVlwPHszRgdfv5IoPO6VheUa2SHYowVynmznYPJNp6+i1Nlg6uLkFfjDjqLVf2iGD34qta5I468tqP59GwfpUu7fguntF/BKKzzBM5q8H5FECueXzdsu5l7UwoNalztF8mV/2LxzqnIwj7LTFXvqb/V5/X4Fo9/9peQ3MQfBIA0ZpjohmKvdQg5uKTJUnK7DinHC6vj2j5dssbfVwjJ0Ngla8jCJ9VwcLy+p8xcIWi07FZhebLCB5RMwo50Kf/Ro3lo5ZaKTum2oWwVjK1/RO7Zcy+yx6HvwWlcfDdVODDNbFDNbR6rVCYyYRQ5/Jo5t6+TQKvng/9qPlLwJYhnjjgpwqyVJTeFvtSBSuE/jtvJlFdn13EYoFYInTdl0ZQB5vamRVfYH22Tzj7R+mjKVCvrfKQYzLQr2JYfpS0burTcilAXArmvo045rs4IBABfJceFX5l52PR2VVV15Ie6PKKqUaBebjdE="
  - secure: "BmyZxmvez+9/0h89YJnwTD1IXcAzjIRkSkYIS1dixKuUQOJm7OHbBNaz2v3vwD2+6aY//Q0y32EcIpiEk9XwvTZeY+bJu4KW6r18EB1g7oiFw1HHTsMBLMH3GpFKRQMQItqkD2Rv7YnLmwmeAVZjGqjRM3nbT28ZcmfGGzBJjO5CK9giCrT78TebHvPDz5rXxv+SubqQ5HSBVdJD7bKTJ7hlkomRBziNfkDMI+1NgSJFyTTjHtut7JHrizoPtinKDKYDtXnURIbiREn4uS5WOYLlrJluLBrRDuinM4JzWjkiisstrXbEFTm+gD6NQlfWjVDhkOPeIr+1oj4INtT6RIkbALZmPLE8/0SD7Hzo0WIDenDUCiYTFCzmfeCrKWGgmhU1Y04xiXWF9u0kNfz6OxbjbXSQ7i0fFkljJ4UWoR+h29CWNkoXmd66Oh7AmLdCNoXdDdCPMTDrCgNk+O1Arrz/sLpRT0cAvqU+wI7Z1ygTdGkURT1P2M0k26ppkSb/yRk9SfT+27oV/6FzxDAxakxKSVn/r8QgsKpTQFGwS+cktvw55exdHVI41yXJ8Td9sknoPJY9K5RTkN+Jbz8gMmSqFaDb3Rg/vUyszBXQzN0qvFPnBW1Ds3hDEGtMaCQq486ttyW/fC5DmTIm0TT3H4zZ0WvBGz60+CY9Qpy4oWo="
  - secure: "CW5aopcalCPP+y32MVVwsSiYBJSir8G77kRpTsb1psA47UbW8+Im8CItOAFx/wDVVncSy6/0a7r/eYC4yUKvB5+yc8Bl8MhCtbLdEaEW3Hr07WcQI0rPVx+urlFKF8QfDbbW5Tm0sKW66sL/3vR7IC7z2/ecLhaCTXwS4r6GcuN1cfZsB2kA7uuPExKR1JloJ8TCcTI7GDd2PLruCTf5z22IGe49amah7pITXmXQm6l+mKyIxJabsnE99PGOrsFfzFlJKMzRc5tE9dkiCmUBSKdfAYVy8E2qkcIo6ypMYqW39ije3w+DtH5KYMjqzDlT9N9Qw1EkMyLwYWur/roNmQp8xxlkNCirniPdqTw3J+DqJqm7HujgoiJ4byN/r2I1ly4sUH1POz9a/iIHAX/Xvka6ce4yyF6+nrdd5cCct0Xb3vOqSpQ9hYWow2iZf04TdMEBcKnjnRoVmWu2BtCbOMe00ve4Ysild2yDxwrg0eD9go2KxVbFYF5HBt+vlyMhybmXn4vbZgtPeEm/zw0bFbiezZVc6a/Zonf/h6RmOVQTepAOhbuA6+gbR/FcLgQYTLRIqYsOEYZ00L9S0Ifqx+jdK5fPERrxafHdufVioBhtfxrTroR9rqX7xfJSLmOojSf8PUOJPZ8F/sBxcrQCUcAefKkoMqUepg3elLGZJJU="